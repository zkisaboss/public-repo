{% extends "base.html" %}
{% block title %}Payments{% endblock %}

{% block content %}
<header class="page-header">
  <h1>Payments</h1>
  <p class="subtitle">Complete transaction and payment history</p>
</header>

<section class="card">
  <div class="flex-row items-center mb-1" style="gap: 0.75rem;">
    <input id="search" type="text" placeholder="Search transaction ID, user, or expense..." class="form-input flex-1"
      style="height: 40px;">

    <select id="status-filter" class="form-input" style="width: auto; min-width: 140px; height: 40px;">
      <option value="">All Statuses</option>
      <option value="completed">Completed</option>
      <option value="pending">Pending</option>
    </select>

    <input id="search" type="text" placeholder="Search transaction ID / user / expense"
      style="padding:0.5rem; border:1px solid #ddd; border-radius:6px; flex:1; min-width:220px;">
  </div>

  <div id="payments-table-container" style="overflow-x: auto;">
    <table class="list-group" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="text-align: left; border-bottom: 2px solid var(--border);">
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Date</th>
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Status</th>
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Amount</th>
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Payer</th>
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Expense</th>
          <th
            style="padding: 1rem 0.75rem; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">
            Transaction ID</th>
        </tr>
      </thead>
      <tbody id="payments-body"></tbody>
    </table>
  </div>

  <div id="empty-payments" class="empty-state" style="display: none;">
    <p>No transactions found matching your criteria.</p>
  </div>
</section>

<a href="{{ url_for('home') }}" class="back-link">‚Üê Back</a>

<script>
  const PAYMENTS_API = "/api/payments";
  let payments = [];

  const bodyEl = document.getElementById("payments-body");
  const tableContainer = document.getElementById("payments-table-container");
  const emptyEl = document.getElementById("empty-payments");
  const statusFilter = document.getElementById("status-filter");
  const searchInput = document.getElementById("search");

  function fmtDate(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function fmtMoney(n, currency = "usd") {
    return new Intl.NumberFormat(undefined, {
      style: "currency",
      currency: (currency || "usd").toUpperCase()
    }).format(n);
  }

  function badge(status) {
    const s = (status || "").toLowerCase();
    const isDone = s === "completed";
    const statusClass = isDone ? "success" : "pending";
    const bgColor = isDone ? "#e6fffa" : "#fff5f5";
    const textColor = isDone ? "var(--success)" : "var(--danger)";
    const borderColor = isDone ? "var(--success)" : "var(--danger)";

    return `<span class="badge" style="background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor};">
      ${status || "unknown"}
    </span>`;
  }

  function render() {
    const status = statusFilter.value.trim().toLowerCase();
    const q = searchInput.value.trim().toLowerCase();

    const filtered = payments.filter(p => {
      if (status && (p.status || "").toLowerCase() !== status) return false;

      if (!q) return true;
      const hay = [
        p.transaction_id,
        p.payer_name,
        String(p.expense_id ?? ""),
        String(p.payment_id ?? "")
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    bodyEl.innerHTML = "";

    if (filtered.length === 0) {
      tableContainer.style.display = "none";
      emptyEl.style.display = "block";
    } else {
      tableContainer.style.display = "block";
      emptyEl.style.display = "none";

      filtered.forEach(p => {
        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid var(--border)";
        tr.innerHTML = `
            <td style="padding: 1rem 0.75rem; font-size: 0.9rem;">${fmtDate(p.created_at)}</td>
            <td style="padding: 1rem 0.75rem;">${badge(p.status)}</td>
            <td style="padding: 1rem 0.75rem; font-weight: 700; color: var(--primary);">${fmtMoney(p.amount, p.currency)}</td>
            <td style="padding: 1rem 0.75rem; font-size: 0.9rem;">${p.payer_name || "-"}</td>
            <td style="padding: 1rem 0.75rem; font-size: 0.9rem; font-weight: 600;">#${p.expense_id ?? "-"}</td>
            <td style="padding: 1rem 0.75rem; font-family: monospace; font-size: 0.8rem; color: var(--text-light);">
              ${p.transaction_id || "-"}
            </td>
          `;
        bodyEl.appendChild(tr);
      });
    }
  }

  async function loadPayments() {
    const res = await fetch(PAYMENTS_API);
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || "Failed to load payments");
      return;
    }
    payments = data;
    render();
  }

  statusFilter.addEventListener("change", render);
  searchInput.addEventListener("input", render);

  loadPayments();
  setInterval(loadPayments, 5000);
</script>
{% endblock %}