{% extends "base.html" %}

{% block title %}Household Chores{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header">
  <h1>Household Chores</h1>
  <p class="subtitle">Manage shared tasks and assignments</p>
</header>

<!-- Create Chore Form -->
<section class="card">
  <h2>Create Chore</h2>
  <div class="form-row-flexible">
    <div class="form-group flex-2">
      <label for="chore-name">Chore Name</label>
      <input id="chore-name" type="text" placeholder="e.g., Take out trash" class="form-input" />
    </div>
    <div class="form-group flex-1">
      <label for="chore-due">Due Date</label>
      <input id="chore-due" type="date" class="form-input" />
    </div>
    <div class="form-group flex-2">
      <label>Assign To</label>
      <div id="assign-dropdown-container"></div>
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button id="add-chore-btn" class="btn-primary" style="height: 40px;">Add</button>
    </div>
  </div>
</section>

<!-- Chore List -->
<section class="card">
  <header class="flex-between mb-1">
    <h2>Chore List</h2>
  </header>
  <div id="chore-list-container" class="list-group"></div>
</section>

<a href="{{ url_for('home') }}" class="back-link">← Back</a>

<script>
  /* ==================== Constants ==================== */

  const API_BASE = "/api/chores";
  const USERS_API = "/api/users";

  /* ==================== State ==================== */

  let allUsers = [];
  let assignDropdown = null;

  /* ==================== DOM Elements ==================== */

  const listContainer = document.getElementById("chore-list-container");
  const nameInput = document.getElementById("chore-name");
  const dueInput = document.getElementById("chore-due");
  const addBtn = document.getElementById("add-chore-btn");
  const assignContainer = document.getElementById("assign-dropdown-container");

  /* ==================== API Functions ==================== */

  async function loadUsers() {
    const res = await fetch(USERS_API);
    allUsers = await res.json();

    const dropdownData = allUsers.map(u => ({ id: u.user_id, label: u.name }));

    assignDropdown = new CustomDropdown(assignContainer, {
      multiple: false,
      placeholder: 'Select user...',
      data: dropdownData
    });
  }

  async function fetchChores() {
    const res = await fetch(API_BASE);
    const data = await res.json();
    renderChores(data);
  }

  async function createChore() {
    const name = nameInput.value.trim();
    const nextDueBy = dueInput.value || null;
    const assignedUserIds = assignDropdown.getSelectedValues();

    if (!name) return;

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, nextDueBy, assignedUserIds }),
    });

    if (res.ok) {
      nameInput.value = "";
      dueInput.value = "";
      assignDropdown.setValues([]);
      await fetchChores();
    }
  }

  async function completeChore(choreId, completedByUserId) {
    if (!completedByUserId) {
      alert("Please select who completed this chore.");
      return;
    }

    const res = await fetch(`${API_BASE}/${choreId}/complete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ completedByUserId: parseInt(completedByUserId, 10) }),
    });

    if (res.ok) {
      await fetchChores();
    }
  }

  async function autoAssignChore(choreId) {
    const res = await fetch(`${API_BASE}/${choreId}/auto-assign`, {
      method: "POST",
    });

    if (res.ok) {
      await fetchChores();
    }
  }

  /* ==================== Helper Functions ==================== */

  function createUserDropdown(choreId, assignedUsers) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex-row gap-05 mt-1";
    wrapper.style.width = "100%";

    const select = document.createElement("select");
    select.id = `complete-user-${choreId}`;
    select.className = "form-input flex-1";
    select.style.height = "32px";
    select.style.fontSize = "0.85rem";
    select.style.padding = "0 0.5rem";

    // Default option
    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "Who did it?";
    select.appendChild(defaultOpt);

    // Populate with assigned users first (if any), then all users
    const usersToShow = assignedUsers && assignedUsers.length > 0 ? assignedUsers : allUsers;

    usersToShow.forEach((user) => {
      const opt = document.createElement("option");
      opt.value = user.user_id;
      opt.textContent = user.name;
      select.appendChild(opt);
    });

    // If showing only assigned users, add separator and other users
    if (assignedUsers && assignedUsers.length > 0) {
      const assignedIds = assignedUsers.map(u => u.user_id);
      const otherUsers = allUsers.filter(u => !assignedIds.includes(u.user_id));

      if (otherUsers.length > 0) {
        const separator = document.createElement("option");
        separator.disabled = true;
        separator.textContent = "── Other users ──";
        select.appendChild(separator);

        otherUsers.forEach((user) => {
          const opt = document.createElement("option");
          opt.value = user.user_id;
          opt.textContent = user.name;
          select.appendChild(opt);
        });
      }
    }

    const completeBtn = document.createElement("button");
    completeBtn.textContent = "Done";
    completeBtn.className = "btn-primary";
    completeBtn.style.height = "32px";
    completeBtn.style.padding = "0 1rem";
    completeBtn.style.fontSize = "0.85rem";
    completeBtn.onclick = () => completeChore(choreId, select.value);

    wrapper.appendChild(select);
    wrapper.appendChild(completeBtn);

    return wrapper;
  }

  /* ==================== Rendering ==================== */

  function renderChores(chores) {
    listContainer.innerHTML = "";

    if (!chores.length) {
      listContainer.innerHTML = `
                <div class="empty-state">
                    <p>No chores assigned yet. Start by adding one above!</p>
                </div>
            `;
      return;
    }

    chores.forEach((chore) => {
      const div = document.createElement("div");
      div.className = "list-item-complex";

      // Build chore info
      const info = document.createElement("div");
      info.className = "item-info";

      const assignedNames = (chore.assignedUsers || [])
        .map((u) => u.name)
        .join(", ") || "None";

      const lastCompletedNames = (chore.lastCompletedBy || [])
        .map((u) => u.name)
        .join(", ") || "None";

      const statusBadge = chore.completed
        ? `<span class="badge" style="background: #e6fffa; color: var(--success); border: 1px solid var(--success);">Completed</span>`
        : `<span class="badge" style="background: #fff5f5; color: var(--danger); border: 1px solid var(--danger);">Pending</span>`;

      const lastDoneHtml = chore.lastCompletedBy.length
        ? `<div class="item-subtitle"><strong>Last done by:</strong> ${lastCompletedNames}</div>`
        : "";

      info.innerHTML = `
                <div class="item-info-row">
                    <span class="item-title">${chore.name}</span>
                    ${statusBadge}
                </div>
                <div class="item-subtitle"><strong>Due:</strong> ${chore.nextDueBy || "No due date"}</div>
                <div class="item-subtitle"><strong>Assigned:</strong> ${assignedNames}</div>
                ${lastDoneHtml}
            `;

      // Build action buttons
      const actions = document.createElement("div");
      actions.className = "item-actions vertical flex-col gap-05";

      if (!chore.completed) {
        // Add user selection dropdown with complete button
        const completionControls = createUserDropdown(chore.choreId, chore.assignedUsers);
        actions.appendChild(completionControls);
      }

      const autoBtn = document.createElement("button");
      autoBtn.innerHTML = "<span>Rotate / Next</span>";
      autoBtn.innerHTML = "<span>Delete Chore</span>";
      autoBtn.className = "btn-secondary";
      autoBtn.style.fontSize = "0.85rem";
      autoBtn.style.height = "32px";
      autoBtn.style.width = "100%";
      autoBtn.onclick = () => autoAssignChore(chore.choreId);
      actions.appendChild(autoBtn);

      // Assemble and append
      div.appendChild(info);
      div.appendChild(actions);
      listContainer.appendChild(div);
    });
  }

  /* ==================== Event Listeners & Initialization ==================== */

  addBtn.addEventListener("click", createChore);

  // Initial load and periodic refresh
  loadUsers().then(fetchChores);
  setInterval(fetchChores, 5000);
</script>
{% endblock %}
