{% extends "base.html" %}

{% block title %}Household Chores{% endblock %}

{% block content %}
HEAD
<style>
  .form-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .create-chore input[type="text"] { flex: 2; }
  .create-chore input[type="date"] { flex: 1; }
  .create-chore select { flex: 2; }
  .create-chore button { flex: 0 0 auto; }

  .chore-item {
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 0.75rem 0; border-bottom: 1px solid #eee;
  }
  .chore-item:last-child { border-bottom: none; }
  .chore-info div { font-size: 0.9rem; color: #555; margin-top: 0.25rem; }

  .chore-actions { display: flex; flex-direction: column; gap: 0.5rem; min-width: 160px; }

  @media (max-width: 600px) {
    .chore-item { flex-direction: column; gap: 1rem; }
    .form-row { flex-direction: column; }
    .chore-actions { width: 100%; flex-direction: row; }
    .chore-actions button { flex: 1; }
  }
</style>


<header class="page-header">
  <h1>Household Chores</h1>
  <p class="subtitle">Manage shared tasks and assignments</p>
</header>

<!-- Create Chore Form -->
<section class="card">
  <h2>Create Chore</h2>
  <div class="form-row-flexible">
    <div class="form-group flex-2">
      <label for="chore-name">Chore Name</label>
      <input id="chore-name" type="text" placeholder="e.g., Take out trash" class="form-input" />
    </div>
    <div class="form-group flex-1">
      <label for="chore-due">Due Date</label>
      <input id="chore-due" type="date" class="form-input" />
    </div>
    <div class="form-group flex-2">
      <label>Assign To</label>
      <div id="assign-dropdown-container"></div>
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button id="add-chore-btn" class="btn-primary" style="height: 40px;">Add</button>
    </div>
  </div>
</section>

<section class="card chore-list">
  <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
    <h2 style="margin:0;">Chore List</h2>
<!-- Chore List -->
<section class="card">
  <header class="flex-between mb-1">
    <h2>Chore List</h2>
  </header>
  <div id="chore-list-container" class="list-group"></div>
</section>

<a href="{{ url_for('home') }}" class="back-link">‚Üê Back</a>

<script>
  /* ==================== Constants ==================== */

  const API_BASE = "/api/chores";
  const USERS_API = "/api/users";

  /* ==================== State ==================== */

  let allUsers = [];
  let assignDropdown = null;

  /* ==================== DOM Elements ==================== */

  const listContainer = document.getElementById("chore-list-container");
  const nameInput = document.getElementById("chore-name");
  const dueInput = document.getElementById("chore-due");
  const addBtn = document.getElementById("add-chore-btn");
  const assignContainer = document.getElementById("assign-dropdown-container");

  /* ==================== API Functions ==================== */

  async function loadUsers() {
    try {
      const res = await fetch(USERS_API);
      if (!res.ok) throw new Error("Failed to fetch users");
      allUsers = await res.json();

      assignedSelect.innerHTML = "";
      allUsers.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.user_id;
        opt.textContent = u.name;
        assignedSelect.appendChild(opt);
      });
    } catch (e) {
      console.error(e);
      assignedSelect.innerHTML = "<option disabled>Error loading users</option>";
    }
  }

  async function fetchChores() {
    try {
      const res = await fetch(API_BASE);
      if (!res.ok) throw new Error("Failed to fetch chores");
      const data = await res.json();
      renderChores(Array.isArray(data) ? data : []);
    } catch (e) {
      console.error(e);
      renderChores([]);
    }
  }

  async function getSelectedAssignedUserIds() {
    return Array.from(assignedSelect.selectedOptions).map(opt => parseInt(opt.value, 10));
    const res = await fetch(USERS_API);
    allUsers = await res.json();

    const dropdownData = allUsers.map(u => ({ id: u.user_id, label: u.name }));

    assignDropdown = new CustomDropdown(assignContainer, {
      multiple: false,
      placeholder: 'Select user...',
      data: dropdownData
    });
  }

  async function fetchChores() {
    const res = await fetch(API_BASE);
    const data = await res.json();
    renderChores(data);
  }

  async function createChore() {
    const name = nameInput.value.trim();
    const nextDueBy = dueInput.value || null;
    const assignedUserIds = assignDropdown.getSelectedValues();

    if (!name) return;

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, nextDueBy, assignedUserIds }),
    });

    if (res.ok) {
      nameInput.value = "";
      dueInput.value = "";
      assignDropdown.setValues([]);
      await fetchChores();
    }
  }

  async function completeChore(choreId, completedByUserId) {
    if (!completedByUserId) {
      alert("Please select who completed this chore.");
      return;
    }

    const res = await fetch(`${API_BASE}/${choreId}/complete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ completedByUserId: parseInt(completedByUserId, 10) }),
    });

    if (res.ok) {
      await fetchChores();
    }
  }

  async function autoAssignChore(choreId) {
    const res = await fetch(`${API_BASE}/${choreId}/auto-assign`, { method: "POST" });
    if (res.ok) await fetchChores();
  }

  function createUserDropdown(choreId, assignedUsers) {
    const wrapper = document.createElement("div");
    wrapper.style.cssText = "display:flex; gap:0.5rem; align-items:center; width:100%;";

    const select = document.createElement("select");
    select.style.cssText = "flex:1; padding:0.25rem 0.5rem; border-radius:4px; border:1px solid #ccc;";

    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "Who did it?";
    select.appendChild(defaultOpt);

    const usersToShow = (assignedUsers && assignedUsers.length) ? assignedUsers : allUsers;
    usersToShow.forEach((u) => {
      const opt = document.createElement("option");
      opt.value = u.user_id;
      opt.textContent = u.name;
      select.appendChild(opt);
    });

    const btn = document.createElement("button");
    btn.textContent = "Done";
    btn.className = "btn-sm btn-primary";
    btn.onclick = () => completeChore(choreId, select.value);

    wrapper.appendChild(select);
    wrapper.appendChild(btn);
    return wrapper;
  }

  function renderChores(chores) {
    listContainer.innerHTML = "";

    if (!chores.length) {
      listContainer.innerHTML =
        '<p class="text-center" style="color:#999; padding:2rem;">No chores yet. Add one above.</p>';
      return;
    }

    chores.forEach((chore) => {
      const choreId = chore.choreId ?? chore.id; // supports either field

      const div = document.createElement("div");
      div.className = "chore-item";

      const info = document.createElement("div");
      info.className = "chore-info";

      const assignedNames = (chore.assignedUsers || []).map(u => u.name).join(", ") || "None";
      const lastCompleted = (chore.lastCompletedBy || []);
      const lastCompletedNames = lastCompleted.map(u => u.name).join(", ") || "None";

      const statusBadge = chore.completed
        ? '<span class="badge" style="background:#d4edda; color:#155724;">Completed</span>'
        : '<span class="badge" style="background:#fff3cd; color:#856404;">Pending</span>';

      info.innerHTML = `
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem;">
          <strong>${chore.name}</strong>
          ${statusBadge}
        </div>
        <div><strong>Due:</strong> ${chore.nextDueBy || "No due date"}</div>
        <div><strong>Assigned:</strong> ${assignedNames}</div>
        ${lastCompleted.length ? `<div><strong>Last done by:</strong> ${lastCompletedNames}</div>` : ""}
      `;

      const actions = document.createElement("div");
      actions.className = "chore-actions";

      if (!chore.completed) {
        actions.appendChild(createUserDropdown(choreId, chore.assignedUsers));
      }

      const autoBtn = document.createElement("button");
      autoBtn.textContent = "Rotate / Next";
      autoBtn.className = "btn-sm btn-secondary";
      autoBtn.onclick = () => autoAssignChore(choreId);
      actions.appendChild(autoBtn);

      div.appendChild(info);
      div.appendChild(actions);
      listContainer.appendChild(div);
    });
  }

  /* ==================== Helper Functions ==================== */

  loadUsers().then(fetchChores);
  setInterval(fetchChores, 3000);
</script>
{% endblock %}
