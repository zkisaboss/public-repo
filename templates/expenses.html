{% extends "base.html" %}

{% block title %}Household Expenses{% endblock %}

{% block content %}

<header class="page-header">
  <h1>Household Expenses</h1>
  <p class="subtitle">Track and split shared household costs</p>
</header>

<section class="card">
  <h2>Add Expense</h2>
  <div class="form-row-flexible">
    <div class="form-group flex-2">
      <label for="expense-description">Description</label>
      <input id="expense-description" type="text" placeholder="e.g., Groceries, Utilities" class="form-input" />
    </div>
    <div class="form-group flex-1">
      <label for="expense-amount">Amount ($)</label>
      <input id="expense-amount" type="number" step="0.01" min="0" placeholder="0.00" class="form-input" />
    </div>
    <div class="form-group flex-1">
      <label for="expense-date">Date</label>
      <input id="expense-date" type="date" class="form-input" />
    </div>
    <div class="form-group flex-1">
      <label>Paid By</label>
      <div id="paid-by-container"></div>
    </div>
    <div class="form-group">
      <label>&nbsp;</label>
      <button id="add-expense-btn" class="btn-primary" style="height: 40px;">Add</button>
    </div>
  </div>

  <div class="toggle-group mt-1">
    <button id="split-even-btn" class="toggle-btn active">Split Evenly</button>
    <button id="split-custom-btn" class="toggle-btn">Custom Split</button>
  </div>

  <div id="custom-split-container" class="toggle-content mt-1">
    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Custom Split (Percentage)</h3>
    <div id="custom-split-users" class="flex-col gap-05"></div>
    <p id="split-total" class="status-text mt-1"></p>
  </div>
</section>

<section class="card">
  <header class="flex-between mb-1">
    <h2 class="m-0">Expense History</h2>
    <div class="flex-row items-center gap-05">
      <label for="filter-user" class="m-0 text-light" style="font-size: 0.85rem;">Filter:</label>
      <select id="filter-user" class="form-input"
        style="height: 32px; font-size: 0.85rem; padding: 0 0.5rem; width: auto; min-width: 140px;">
        <option value="">All Users</option>
      </select>
    </div>
  </header>
  <div id="expense-list-container" class="list-group"></div>
</section>

<a href="{{ url_for('home') }}" class="back-link">← Back</a>

<script>
  /* ------------------ JavaScript ------------------ */

  const API_BASE = "/api/expenses";
  const USERS_API = "/api/users";

  const listContainer = document.getElementById("expense-list-container");
  const descriptionInput = document.getElementById("expense-description");
  const amountInput = document.getElementById("expense-amount");
  const dateInput = document.getElementById("expense-date");
  const paidByContainer = document.getElementById("paid-by-container");

  const addBtn = document.getElementById("add-expense-btn");
  const splitEvenBtn = document.getElementById("split-even-btn");
  const splitCustomBtn = document.getElementById("split-custom-btn");
  const customSplitContainer = document.getElementById("custom-split-container");
  const customSplitUsers = document.getElementById("custom-split-users");
  const splitTotalText = document.getElementById("split-total");
  const filterUserSelect = document.getElementById("filter-user");

  let users = [];
  let expenses = [];
  let splitMode = "even";
  let customSplits = {};
  let currentEditId = null;
  let paidByDropdown = null;

  // Set today's date as default
  dateInput.valueAsDate = new Date();

  async function loadUsers() {
    const res = await fetch(USERS_API);
    users = await res.json();

    const dropdownData = users.map(u => ({ id: u.user_id, label: u.name }));

    // Initialize custom dropdowns
    paidByDropdown = new CustomDropdown(paidByContainer, {
      multiple: true,
      placeholder: 'Select users...',
      data: dropdownData
    });



    // Populate filter select
    filterUserSelect.innerHTML = '<option value="">All Users</option>';
    users.forEach((u) => {
      const opt = document.createElement("option");
      opt.value = u.user_id;
      opt.textContent = u.name;
      filterUserSelect.appendChild(opt);
    });

    // Initialize custom split
    initializeCustomSplit();
  }

  function initializeCustomSplit() {
    customSplitUsers.innerHTML = "";
    customSplits = {};

    users.forEach((u) => {
      customSplits[u.user_id] = 0;

      const row = document.createElement("div");
      row.className = "flex-row items-center gap-1";

      const label = document.createElement("label");
      label.textContent = u.name;
      label.className = "flex-1 m-0";
      label.style.fontSize = "0.9rem";

      const inputContainer = document.createElement("div");
      inputContainer.className = "input-group";
      inputContainer.style.width = "100px";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.max = "100";
      input.step = "0.01";
      input.value = "0";
      input.className = "input-transparent";
      input.style.width = "100%";
      input.dataset.userId = u.user_id;
      input.addEventListener("input", updateSplitTotal);

      const percent = document.createElement("span");
      percent.textContent = "%";
      percent.style.marginLeft = "0.25rem";

      inputContainer.appendChild(input);
      inputContainer.appendChild(percent);

      row.appendChild(label);
      row.appendChild(inputContainer);
      customSplitUsers.appendChild(row);
    });

    updateSplitTotal();
  }

  function updateSplitTotal() {
    let total = 0;
    const inputs = customSplitUsers.querySelectorAll("input");
    inputs.forEach((input) => {
      const val = parseFloat(input.value) || 0;
      customSplits[input.dataset.userId] = val;
      total += val;
    });

    splitTotalText.textContent = `Total: ${total.toFixed(2)}%`;
    splitTotalText.className = "status-text mt-1 " + (Math.abs(total - 100) < 0.01 ? "success" : "error");
  }

  splitEvenBtn.addEventListener("click", () => {
    splitMode = "even";
    splitEvenBtn.classList.add("active");
    splitCustomBtn.classList.remove("active");
    customSplitContainer.classList.remove("active");
  });

  splitCustomBtn.addEventListener("click", () => {
    splitMode = "custom";
    splitCustomBtn.classList.add("active");
    splitEvenBtn.classList.remove("active");
    customSplitContainer.classList.add("active");
  });

  async function fetchExpenses() {
    // Don't refresh while user is editing inline
    if (currentEditId !== null) return;
    try {
      const res = await fetch(API_BASE);
      if (!res.ok) return; // Don't wipe existing data on error
      expenses = await res.json();
      renderExpenses();
    } catch (e) {
      console.error('Failed to fetch expenses:', e);
    }
  }

  function renderExpenses() {
    const filterUserId = filterUserSelect.value;
    let filtered = expenses;

    if (filterUserId) {
      filtered = expenses.filter(e =>
        e.paidBy.user_id == filterUserId ||
        e.splits.some(s => s.user_id == filterUserId)
      );
    }

    listContainer.innerHTML = "";
    if (!filtered.length) {
      listContainer.innerHTML = `
        <div class="empty-state">
            <p>No expenses found. Track shared costs by adding one above!</p>
        </div>
      `;
      return;
    }

    filtered.forEach((expense) => {
      const div = document.createElement("div");
      div.className = "list-item-complex";
      div.id = `expense-row-${expense.expenseId}`;

      try {
        if (currentEditId === expense.expenseId) {
          renderInlineEditForm(div, expense);
        } else {
          renderExpenseRow(div, expense);
        }
      } catch (err) {
        console.error('Error rendering expense row:', expense.expenseId, err);
        div.innerHTML = `<div class="item-info"><span class="item-title">${expense.description} — $${parseFloat(expense.amount).toFixed(2)}</span></div>`;
      }

      listContainer.appendChild(div);
    });
  }

  async function createExpense() {
    const description = descriptionInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const date = dateInput.value;
    const paidByValues = paidByDropdown.getSelectedValues();
    const paidByUserId = paidByValues.length > 0 ? paidByValues[0] : null;

    if (!description || !amount || amount <= 0 || !date || !paidByUserId) {
      alert("Please fill in all fields with valid values.");
      return;
    }

    let splits;
    if (splitMode === "even") {
      splits = users.map(u => ({
        user_id: u.user_id,
        percentage: 100 / users.length
      }));
    } else {
      const total = Object.values(customSplits).reduce((a, b) => a + b, 0);
      if (Math.abs(total - 100) > 0.01) {
        alert("Custom split percentages must total 100%");
        return;
      }
      splits = Object.entries(customSplits)
        .filter(([_, pct]) => pct > 0)
        .map(([user_id, percentage]) => ({
          user_id: parseInt(user_id),
          percentage
        }));
    }

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ description, amount, date, paidByUserId, splits }),
    });

    if (res.ok) {
      descriptionInput.value = "";
      amountInput.value = "";
      dateInput.valueAsDate = new Date();
      paidByDropdown.setValues([]);
      initializeCustomSplit();
      // Force fetch even though currentEditId might be null
      try {
        const refreshRes = await fetch(API_BASE);
        if (refreshRes.ok) {
          expenses = await refreshRes.json();
          renderExpenses();
        }
      } catch (e) {
        console.error('Failed to refresh expenses:', e);
      }
    }
  }

  function renderExpenseRow(div, expense) {
    // Determine per-user payment status
    const paidUserIds = new Set();
    if (expense.payments && expense.payments.length) {
      expense.payments.forEach(p => {
        const s = (p.status || '').toLowerCase();
        if (['completed', 'confirmed', 'paid', 'succeeded', 'success'].includes(s)) {
          paidUserIds.add(p.user_id);
        }
      });
    }
    // The payer is always considered "paid"
    paidUserIds.add(expense.paidBy.user_id);

    const allPaid = expense.splits.every(s => paidUserIds.has(s.user_id));
    const statusLabel = allPaid ? 'Completed' : 'Pending';
    const statusStyle = allPaid
      ? 'background: #e6fffa; color: var(--success); border: 1px solid var(--success);'
      : 'background: #fff5f5; color: var(--danger); border: 1px solid var(--danger);';

    // Build split breakdown HTML with payment indicators
    const splitRows = expense.splits.map(s => {
      const hasPaid = paidUserIds.has(s.user_id);
      const indicator = hasPaid
        ? `<span style="color: var(--success); font-weight: 600;">\u2705 Paid</span>`
        : `<span style="color: #e07c00; font-weight: 600;">\u23F3 Unpaid</span>`;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.2rem 0; font-size: 0.85rem;">
          <span>${s.user_name}</span>
          <span style="display: flex; gap: 0.75rem; align-items: center;">
            <span style="font-weight: 600;">$${s.amount.toFixed(2)}</span>
            <span class="text-light" style="font-size: 0.8rem;">(${s.percentage.toFixed(1)}%)</span>
            ${indicator}
          </span>
        </div>`;
    }).join('');

    const info = document.createElement("div");
    info.className = "item-info";
    info.style.flex = '1';
    info.innerHTML = `
      <div class="item-info-row">
        <span class="item-title">${expense.description}</span>
        <span style="display: flex; gap: 0.5rem; align-items: center;">
          <span class="item-amount" style="color: var(--primary);">$${parseFloat(expense.amount).toFixed(2)}</span>
          <span class="badge" style="${statusStyle}">${statusLabel}</span>
        </span>
      </div>
      <div class="item-subtitle"><strong>Date:</strong> ${expense.date}</div>
      <div class="item-subtitle"><strong>Paid by:</strong> ${expense.paidBy.name}</div>
      <div style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 0.5rem;">
        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">Split Breakdown</div>
        ${splitRows}
      </div>
    `;

    const actions = document.createElement("div");
    actions.className = "item-actions vertical flex-col gap-05";

    const mainActions = document.createElement("div");
    mainActions.className = "flex-row gap-05";

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "btn-secondary";
    editBtn.style.padding = "0.25rem 0.75rem";
    editBtn.style.fontSize = "0.85rem";
    editBtn.style.height = "32px";
    editBtn.onclick = () => startInlineEdit(expense.expenseId);
    mainActions.appendChild(editBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn-secondary";
    deleteBtn.style.padding = "0.25rem 0.75rem";
    deleteBtn.style.fontSize = "0.85rem";
    deleteBtn.style.height = "32px";
    deleteBtn.style.color = "var(--danger)";
    deleteBtn.onclick = () => deleteExpense(expense.expenseId);
    mainActions.appendChild(deleteBtn);

    actions.appendChild(mainActions);

    if (!allPaid) {
      const payBtn = document.createElement("button");
      payBtn.textContent = "Pay via Stripe";
      payBtn.className = "btn-primary w-100";
      payBtn.style.fontSize = "0.85rem";
      payBtn.style.height = "32px";
      payBtn.onclick = () => payExpense(expense.expenseId);
      actions.appendChild(payBtn);
    }

    div.appendChild(info);
    div.appendChild(actions);
  }

  function renderInlineEditForm(div, expense) {
    div.innerHTML = '';
    div.style.flexDirection = 'column';
    div.style.gap = '0.75rem';

    const dropdownData = users.map(u => ({ id: u.user_id, label: u.name }));

    div.innerHTML = `
      <div class="form-row-flexible" style="width: 100%;">
        <div class="form-group flex-2">
          <label>Description</label>
          <input data-field="desc" type="text" class="form-input" value="${expense.description}" />
        </div>
        <div class="form-group flex-1">
          <label>Amount ($)</label>
          <input data-field="amt" type="number" step="0.01" min="0" class="form-input" value="${expense.amount}" />
        </div>
        <div class="form-group flex-1">
          <label>Date</label>
          <input data-field="date" type="date" class="form-input" value="${expense.date}" />
        </div>
        <div class="form-group flex-1">
          <label>Paid By</label>
          <div data-field="paidby"></div>
        </div>
      </div>
      <div class="flex-row gap-05 justify-end">
        <button class="btn-secondary" data-action="cancel">Cancel</button>
        <button class="btn-primary" data-action="save">Save Changes</button>
      </div>
    `;

    // Use div.querySelector to find elements within the detached div (not yet in document)
    const paidByEl = div.querySelector('[data-field="paidby"]');
    const inlineDropdown = new CustomDropdown(paidByEl, {
      multiple: true,
      placeholder: 'Select users...',
      data: dropdownData
    });
    inlineDropdown.setValues([expense.paidBy.user_id]);

    div.querySelector('[data-action="cancel"]').onclick = () => cancelInlineEdit();
    div.querySelector('[data-action="save"]').onclick = () => saveInlineEdit(expense.expenseId, inlineDropdown, div);
  }

  function startInlineEdit(expenseId) {
    currentEditId = expenseId;
    renderExpenses();
  }

  function cancelInlineEdit() {
    currentEditId = null;
    renderExpenses();
  }

  async function saveInlineEdit(expenseId, inlineDropdown, div) {
    const description = div.querySelector('[data-field="desc"]').value.trim();
    const amount = parseFloat(div.querySelector('[data-field="amt"]').value);
    const date = div.querySelector('[data-field="date"]').value;
    const paidByValues = inlineDropdown.getSelectedValues();
    const paidByUserId = paidByValues.length > 0 ? paidByValues[0] : null;

    if (!description || !amount || amount <= 0 || !date || !paidByUserId) {
      alert("Please fill in all fields with valid values.");
      return;
    }

    const res = await fetch(`${API_BASE}/${expenseId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ description, amount, date, paidByUserId }),
    });

    if (res.ok) {
      currentEditId = null;
      try {
        const refreshRes = await fetch(API_BASE);
        if (refreshRes.ok) {
          expenses = await refreshRes.json();
          renderExpenses();
        }
      } catch (e) {
        console.error('Failed to refresh expenses:', e);
      }
    }
  }

  async function deleteExpense(expenseId) {
    if (!confirm("Are you sure you want to delete this expense?")) return;

    const res = await fetch(`${API_BASE}/${expenseId}`, {
      method: "DELETE",
    });

    if (res.ok) {
      await fetchExpenses();
    }
  }



  async function payExpense(expenseId) {
    const res = await fetch(`${API_BASE}/${expenseId}/pay`, { method: "POST" });
    const data = await res.json();

    if (!res.ok) {
      alert(data.error || "Payment failed");
      return;
    }

    // Redirect to Stripe Checkout
    window.location.href = data.checkout_url;
  }

  addBtn.addEventListener("click", createExpense);
  filterUserSelect.addEventListener("change", renderExpenses);

  // Initialize
  loadUsers().then(fetchExpenses);
  setInterval(fetchExpenses, 5000);
</script>
{% endblock %}