{% extends 'base.html' %}
{% block title %}Groceries{% endblock %}
{% block content %}
<header class="page-header">
    <h1>Groceries</h1>
    <p class="subtitle">{{ group.name }}</p>
</header>

<!-- Receipt Scanner -->
<section class="card">
    <h2>Scan Receipt</h2>
    <div id="dropZone" class="drop-zone">
        <div class="drop-zone-content">
            <p>Drag & drop receipt image</p>
            <p class="hint">or click to browse</p>
        </div>
        <img id="previewImage" class="preview-image hidden" alt="Receipt preview">
        <input type="file" id="receiptInput" accept="image/*" hidden>
    </div>
    <div class="scan-controls">
        <button type="button" id="scanBtn" class="btn-primary" disabled>Scan</button>
        <button type="button" id="clearImageBtn" class="btn-secondary hidden">Clear</button>
    </div>
    <output id="scanStatus" class="status-msg" aria-live="polite"></output>
</section>

<!-- Scanned Items Preview -->
<section id="scannedPreview" class="card hidden">
    <h2>Scanned Items</h2>
    <p class="hint">Review before adding</p>
    <ul id="scannedItems"></ul>
    <div class="btn-group">
        <button type="button" id="addAllBtn" class="btn-primary">Add All</button>
        <button type="button" id="clearScanBtn" class="btn-secondary">Cancel</button>
    </div>
</section>

<!-- Shopping List -->
<section class="card">
    <header>
        <h2>Shopping List</h2>
        <span class="badge" id="itemCount">{{ items|length }} items</span>
    </header>

    <form id="addItemForm" class="add-item-form">
        <input type="text" name="name" placeholder="Add item..." required>
        <input type="number" name="quantity" value="1" min="1">
        <button type="submit">+</button>
    </form>

    <ul id="groceryList">
        {% for item in items %}
        <li data-id="{{ item.id }}" {% if item.selected %} class="selected" {% endif %}>
            <label class="checkbox">
                <input type="checkbox" name="selected" {{ ' checked' if item.selected else '' }}>
            </label>
            <input type="text" name="name" value="{{ item.name }}">
            <fieldset class="qty-control">
                <button type="button" data-action="decrement">−</button>
                <output>{{ item.quantity }}</output>
                <button type="button" data-action="increment">+</button>
            </fieldset>
            <label class="price-field">
                <span>$</span>
                <input type="number" name="price" value="{{ item.price or '' }}" step="0.01" min="0" placeholder="0.00">
            </label>
            <button type="button" data-action="delete" class="btn-delete">×</button>
        </li>
        {% else %}
        <li class="empty-state">No items yet</li>
        {% endfor %}
    </ul>

    <footer>
        <div class="selection-summary">
            <span><output id="selectedCount">0</output> selected</span>
            <strong>Total: $<output id="totalPrice">0.00</output></strong>
        </div>
        <button type="button" id="payBtn" class="btn-primary" disabled>Pay for Selected</button>
    </footer>
</section>

<a href="{{ url_for('home') }}" class="back-link">← Back</a>

<style>
    /* Layout */
    .page-header {
        margin-bottom: 1.5rem;
    }

    .subtitle {
        color: #666;
        margin: 0;
    }

    .card {
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
    }

    .card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .card header h2 {
        margin: 0;
    }

    .card footer {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .hidden {
        display: none !important;
    }

    .hint {
        color: #999;
        font-size: 0.85rem;
    }

    .badge {
        background: #e8f4ff;
        color: #007bff;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
    }

    .btn-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .back-link {
        display: inline-block;
        margin-top: 1rem;
        color: #666;
    }

    /* Buttons */
    .btn-primary,
    .btn-secondary {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: #007bff;
        color: #fff;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-delete {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.25rem;
    }

    .btn-delete:hover {
        color: #dc3545;
    }

    /* Drop Zone */
    .drop-zone {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        background: #fafafa;
        transition: all 0.2s;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
        border-color: #007bff;
        background: #f0f7ff;
    }

    .drop-zone p {
        margin: 0.25rem 0;
        color: #666;
    }

    .preview-image {
        max-width: 100%;
        max-height: 250px;
        border-radius: 4px;
    }

    .scan-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .status-msg {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }

    .status-msg.error {
        color: #dc3545;
    }

    .status-msg.success {
        color: #28a745;
    }

    /* Add Form */
    .add-item-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }

    .add-item-form input[type="text"] {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .add-item-form input[type="number"] {
        width: 60px;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-align: center;
    }

    .add-item-form button {
        width: 40px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .add-item-form button:hover {
        background: #0056b3;
    }

    /* Grocery List */
    #groceryList {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #groceryList li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    #groceryList li:last-child {
        border-bottom: none;
    }

    #groceryList li.selected {
        background: #f0f7ff;
        margin: 0 -1.5rem;
        padding: 0.75rem 1.5rem;
    }

    #groceryList li.selected input[name="name"] {
        background: transparent;
    }

    .empty-state {
        color: #999;
        text-align: center;
        padding: 2rem 0 !important;
        justify-content: center;
    }

    /* Checkbox */
    .checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Item Name */
    #groceryList input[name="name"] {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.25rem;
        font-size: 0.95rem;
    }

    #groceryList input[name="name"]:focus {
        outline: none;
        background: #fff;
        box-shadow: 0 0 0 2px #007bff33;
        border-radius: 4px;
    }

    /* Quantity Control */
    .qty-control {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        border: none;
        padding: 0;
        margin: 0;
        background: #f5f5f5;
        border-radius: 6px;
    }

    .qty-control button {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
    }

    .qty-control button:hover {
        background: #e8e8e8;
        border-radius: 4px;
    }

    .qty-control output {
        width: 28px;
        text-align: center;
        font-size: 0.9rem;
    }

    /* Price Field */
    .price-field {
        display: flex;
        align-items: center;
        background: #f5f5f5;
        border-radius: 6px;
        padding: 0 0.5rem;
    }

    .price-field span {
        color: #999;
        font-size: 0.85rem;
    }

    .price-field input {
        width: 50px;
        border: none;
        background: transparent;
        text-align: right;
        font-size: 0.9rem;
        padding: 0.35rem 0;
    }

    .price-field input:focus {
        outline: none;
    }

    /* Footer */
    .selection-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .selection-summary span {
        color: #666;
    }

    /* Scanned Items */
    #scannedItems {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #scannedItems li {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 0;
        align-items: center;
    }

    #scannedItems input[type="text"] {
        flex: 1;
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #scannedItems input[type="number"] {
        width: 60px;
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    #scannedItems button {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 1.1rem;
    }

    #scannedItems button:hover {
        color: #dc3545;
    }
</style>

<script>
    (function () {
        "use strict";

        const $ = (s, p = document) => p.querySelector(s);
        const $$ = (s, p = document) => [...p.querySelectorAll(s)];

        // State
        let imageData = null;
        let scannedData = [];

        // Elements
        const el = {
            dropZone: $("#dropZone"),
            receiptInput: $("#receiptInput"),
            previewImage: $("#previewImage"),
            scanBtn: $("#scanBtn"),
            clearImageBtn: $("#clearImageBtn"),
            scanStatus: $("#scanStatus"),
            scannedPreview: $("#scannedPreview"),
            scannedItems: $("#scannedItems"),
            addAllBtn: $("#addAllBtn"),
            clearScanBtn: $("#clearScanBtn"),
            addItemForm: $("#addItemForm"),
            groceryList: $("#groceryList"),
            totalPrice: $("#totalPrice"),
            selectedCount: $("#selectedCount"),
            payBtn: $("#payBtn"),
            itemCount: $("#itemCount")
        };

        // API helper
        const api = async (url, method = "GET", body = null) => {
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: body ? JSON.stringify(body) : null
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Request failed");
            return data;
        };

        const setStatus = (msg, type = "") => {
            el.scanStatus.textContent = msg;
            el.scanStatus.className = "status-msg" + (type ? ` ${type}` : "");
        };

        const escapeHtml = (str) => {
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        };

        // Update totals
        const updateTotals = () => {
            const selected = $$("#groceryList li.selected");
            let total = 0;
            selected.forEach(li => {
                const price = parseFloat($("[name=price]", li)?.value) || 0;
                const qty = parseInt($("output", li)?.textContent) || 1;
                total += price * qty;
            });
            el.totalPrice.textContent = total.toFixed(2);
            el.selectedCount.textContent = selected.length;
            el.payBtn.disabled = selected.length === 0;
        };

        const updateItemCount = () => {
            const count = $$("#groceryList li[data-id]").length;
            el.itemCount.textContent = `${count} item${count !== 1 ? "s" : ""}`;
        };

        // Image handling
        const showImage = (src) => {
            imageData = src;
            el.previewImage.src = src;
            el.previewImage.classList.remove("hidden");
            $(".drop-zone-content").classList.add("hidden");
            el.scanBtn.disabled = false;
            el.clearImageBtn.classList.remove("hidden");
            setStatus("Ready to scan", "success");
        };

        const clearImage = () => {
            imageData = null;
            el.previewImage.src = "";
            el.previewImage.classList.add("hidden");
            $(".drop-zone-content").classList.remove("hidden");
            el.scanBtn.disabled = true;
            el.clearImageBtn.classList.add("hidden");
            el.receiptInput.value = "";
            setStatus("");
        };

        const loadFile = (file) => {
            if (!file?.type.startsWith("image/")) {
                setStatus("Please select an image", "error");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => showImage(e.target.result);
            reader.readAsDataURL(file);
        };

        // Scanning
        const scanReceipt = async () => {
            if (!imageData) return;
            el.scanBtn.disabled = true;
            setStatus("Scanning...");
            try {
                const { items = [] } = await api("/groceries/upload", "POST", { image: imageData });
                if (!items.length) {
                    setStatus("No items found", "error");
                    return;
                }
                scannedData = items;
                setStatus(`Found ${items.length} items`, "success");
                renderScanned();
            } catch (e) {
                setStatus(e.message, "error");
            } finally {
                el.scanBtn.disabled = false;
            }
        };

        const renderScanned = () => {
            el.scannedItems.innerHTML = scannedData.map((item, i) => `
      <li data-index="${i}">
        <input type="text" name="name" value="${escapeHtml(item.name)}">
        <input type="number" name="quantity" value="${item.quantity}" min="1">
        <input type="number" name="price" value="${item.price || ""}" step="0.01" placeholder="$">
        <button type="button" data-action="remove">×</button>
      </li>
    `).join("");
            el.scannedPreview.classList.remove("hidden");
        };

        const clearScanned = () => {
            scannedData = [];
            el.scannedPreview.classList.add("hidden");
            el.scannedItems.innerHTML = "";
        };

        const addAllScanned = async () => {
            const items = $$("#scannedItems li").map(li => ({
                name: $("[name=name]", li).value.trim(),
                quantity: parseInt($("[name=quantity]", li).value) || 1,
                price: parseFloat($("[name=price]", li).value) || null
            })).filter(i => i.name);
            if (!items.length) return;
            try {
                await api("/groceries/bulk-add", "POST", { items });
                location.reload();
            } catch (e) {
                setStatus(e.message, "error");
            }
        };

        // Create item element
        const createItem = ({ id, name, quantity, price }) => {
            const li = document.createElement("li");
            li.dataset.id = id;
            li.innerHTML = `
      <label class="checkbox"><input type="checkbox" name="selected"></label>
      <input type="text" name="name" value="${escapeHtml(name)}">
      <fieldset class="qty-control">
        <button type="button" data-action="decrement">−</button>
        <output>${quantity}</output>
        <button type="button" data-action="increment">+</button>
      </fieldset>
      <label class="price-field">
        <span>$</span>
        <input type="number" name="price" value="${price || ""}" step="0.01" min="0" placeholder="0.00">
      </label>
      <button type="button" data-action="delete" class="btn-delete">×</button>
    `;
            return li;
        };

        // CRUD operations
        const addItem = async (e) => {
            e.preventDefault();
            const form = e.target;
            const name = form.name.value.trim();
            if (!name) return;
            try {
                const item = await api("/groceries/add", "POST", {
                    name,
                    quantity: parseInt(form.quantity.value) || 1,
                    price: null
                });
                $(".empty-state", el.groceryList)?.remove();
                el.groceryList.appendChild(createItem(item));
                form.reset();
                form.quantity.value = "1";
                form.name.focus();
                updateItemCount();
            } catch (e) {
                alert(e.message);
            }
        };

        const updateItem = async (id, field, value) => {
            try {
                await api(`/groceries/${id}`, "PUT", { [field]: value });
            } catch (e) {
                alert(e.message);
            }
        };

        const deleteItem = async (li) => {
            try {
                await api(`/groceries/${li.dataset.id}`, "DELETE");
                li.remove();
                updateTotals();
                updateItemCount();
                if (!$("[data-id]", el.groceryList)) {
                    el.groceryList.innerHTML = '<li class="empty-state">No items yet</li>';
                }
            } catch (e) {
                alert(e.message);
            }
        };

        const paySelected = async () => {
            const ids = $$("#groceryList li.selected").map(li => li.dataset.id);
            if (!ids.length) return;
            try {
                await api("/groceries/pay", "POST", { item_ids: ids });
                location.reload();
            } catch (e) {
                alert(e.message);
            }
        };

        // Event: Drop zone
        el.dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.dropZone.classList.add("dragover");
        });
        el.dropZone.addEventListener("dragleave", () => el.dropZone.classList.remove("dragover"));
        el.dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            el.dropZone.classList.remove("dragover");
            loadFile(e.dataTransfer.files[0]);
        });
        el.dropZone.addEventListener("click", () => el.receiptInput.click());
        el.receiptInput.addEventListener("change", (e) => loadFile(e.target.files[0]));

        // Event: Scan controls
        el.scanBtn.addEventListener("click", scanReceipt);
        el.clearImageBtn.addEventListener("click", clearImage);
        el.addAllBtn.addEventListener("click", addAllScanned);
        el.clearScanBtn.addEventListener("click", clearScanned);

        // Event: Scanned items
        el.scannedItems.addEventListener("click", (e) => {
            if (e.target.dataset.action === "remove") {
                const i = parseInt(e.target.closest("li").dataset.index);
                scannedData.splice(i, 1);
                scannedData.length ? renderScanned() : clearScanned();
            }
        });

        // Event: Add item form
        el.addItemForm.addEventListener("submit", addItem);

        // Event: Grocery list
        el.groceryList.addEventListener("click", (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;

            const action = e.target.dataset.action;
            const output = $("output", li);
            let qty = parseInt(output?.textContent) || 1;

            if (action === "increment") {
                qty++;
                output.textContent = qty;
                updateItem(li.dataset.id, "quantity", qty);
                updateTotals();
            } else if (action === "decrement" && qty > 1) {
                qty--;
                output.textContent = qty;
                updateItem(li.dataset.id, "quantity", qty);
                updateTotals();
            } else if (action === "delete") {
                deleteItem(li);
            }
        });

        el.groceryList.addEventListener("change", (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;

            const { name, value, checked } = e.target;

            if (name === "selected") {
                li.classList.toggle("selected", checked);
                updateTotals();
            } else if (name === "name") {
                updateItem(li.dataset.id, "name", value.trim());
            } else if (name === "price") {
                updateItem(li.dataset.id, "price", parseFloat(value) || null);
                updateTotals();
            }
        });

        // Event: Pay button
        el.payBtn.addEventListener("click", paySelected);

        // Initialize
        updateTotals();
    })();
</script>
{% endblock %}