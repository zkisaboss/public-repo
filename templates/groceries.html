{% extends 'base.html' %}
{% block title %}Groceries{% endblock %}
{% block content %}
<header class="page-header">
    <h1>Groceries</h1>
    <p class="subtitle">{{ group.name }}</p>
</header>

<!-- Receipt Scanner -->
<section class="card">
    <h2>Scan Receipt</h2>
    <div id="dropZone" class="drop-zone">
        <div class="drop-zone-content">
            <p>Drag & drop receipt image</p>
            <p class="hint">or click to browse</p>
        </div>
        <img id="previewImage" class="preview-image hidden" alt="Receipt preview">
        <input type="file" id="receiptInput" accept="image/*" hidden>
    </div>
    <div class="flex-row gap-1 mt-1">
        <button type="button" id="scanBtn" class="btn-primary" disabled>Scan</button>
        <button type="button" id="clearImageBtn" class="btn-secondary hidden">Clear</button>
    </div>
    <output id="scanStatus" class="status-text" aria-live="polite"></output>
</section>

<!-- Scanned Items Preview -->
<section id="scannedPreview" class="card hidden">
    <h2>Scanned Items</h2>
    <p class="hint mb-1">Review before adding to list</p>
    <ul id="scannedItems" class="list-group"></ul>
    <div class="flex-row gap-1 mt-1">
        <button type="button" id="addAllBtn" class="btn-primary flex-1">Add All</button>
        <button type="button" id="clearScanBtn" class="btn-secondary flex-1">Cancel</button>
    </div>
</section>

<!-- Shopping List -->
<section class="card">
    <header class="flex-between">
        <h2>Shopping List</h2>
        <span class="badge" id="itemCount">{{ items|length }} items</span>
    </header>

    <form id="addItemForm" class="form-row">
        <input type="text" name="name" placeholder="Add item..." required class="form-input">
        <fieldset class="quantity-control">
            <button type="button" data-action="decrement">−</button>
            <output id="addItemQty">1</output>
            <button type="button" data-action="increment">+</button>
        </fieldset>
        <button type="submit">+</button>
    </form>
    <ul class="list-group mb-2" id="addItemSection">
        <li class="list-item" style="border-bottom: 2px solid var(--primary); padding-bottom: 1rem;">
            <div class="flex-1">
                <input type="text" id="groceryName" name="name" placeholder="Add new item..." required
                    class="input-transparent w-100">
            </div>
            <div class="flex-row items-center" style="gap: 0.75rem;">
                <fieldset class="quantity-control">
                    <button type="button" data-action="decrement">−</button>
                    <output id="addItemQty">1</output>
                    <button type="button" data-action="increment">+</button>
                </fieldset>
                <button type="button" id="addItemBtn" class="btn-primary"
                    style="padding: 0 1.5rem; height: 40px;">Add</button>
            </div>
        </li>
    </ul>

    <ul id="groceryList" class="list-group">
        {% for item in items %}
        <li data-id="{{ item.id }}" class="list-item {% if item.selected %}selected{% endif %}">
            <label class="checkbox flex-shrink-0">
                <input type="checkbox" name="selected" {{ ' checked' if item.selected else '' }}>
            </label>
            <div class="flex-1">
                <input type="text" name="name" value="{{ item.name }}" class="input-transparent w-100"
                    placeholder="Item name">
            </div>
            <div class="flex-row items-center gap-05">
                <fieldset class="quantity-control">
                    <button type="button" data-action="decrement">−</button>
                    <output>{{ item.quantity }}</output>
                    <button type="button" data-action="increment">+</button>
                </fieldset>
                <div class="input-group">
                    <span>$</span>
                    <input type="number" name="price" value="{{ item.price if item.price is not none else '0.00' }}"
                        step="0.01" min="0" placeholder="0.00">
                </div>
                <button type="button" data-action="delete" class="btn-icon">×</button>
            </div>
        </li>
        {% else %}
        <li class="empty-state">No items yet</li>
        {% endfor %}
    </ul>

    <footer class="card-footer" style="margin-top: 1.5rem;">
        <div class="flex-between" style="margin-bottom: 0.75rem;">
            <span class="text-light"><output id="selectedCount">0</output> selected</span>
            <span class="item-amount">Total: $<output id="totalPrice">0.00</output></span>
        </div>
        <button type="button" id="payBtn" class="btn-primary w-100" disabled>Pay for Selected</button>
    </footer>
</section>

<a href="{{ url_for('home') }}" class="back-link" style="margin-top:1rem;color:#666;display:inline-block;">← Back</a>

<script>
    (function () {
        "use strict";

        const $ = (s, p = document) => p.querySelector(s);
        const $$ = (s, p = document) => [...p.querySelectorAll(s)];

        // State
        let imageData = null;
        let scannedData = [];

        // Elements
        const el = {
            dropZone: $("#dropZone"),
            receiptInput: $("#receiptInput"),
            previewImage: $("#previewImage"),
            scanBtn: $("#scanBtn"),
            clearImageBtn: $("#clearImageBtn"),
            scanStatus: $("#scanStatus"),
            scannedPreview: $("#scannedPreview"),
            scannedItems: $("#scannedItems"),
            addAllBtn: $("#addAllBtn"),
            clearScanBtn: $("#clearScanBtn"),
            addItemSection: $("#addItemSection"),
            addItemName: $("#groceryName"),
            addItemBtn: $("#addItemBtn"),
            groceryList: $("#groceryList"),
            totalPrice: $("#totalPrice"),
            selectedCount: $("#selectedCount"),
            payBtn: $("#payBtn"),
            itemCount: $("#itemCount")
        };

        // API helper
        const api = async (url, method = "GET", body = null) => {
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: body ? JSON.stringify(body) : null
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Request failed");
            return data;
        };

        const setStatus = (msg, type = "") => {
            el.scanStatus.textContent = msg;
            el.scanStatus.className = "status-text" + (type ? ` ${type}` : "");
        };

        const escapeHtml = (str) => {
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        };

        // Update totals
        const updateTotals = () => {
            const selected = $$("#groceryList li.selected");
            let total = 0;
            selected.forEach(li => {
                const price = parseFloat($("[name=price]", li)?.value) || 0;
                const qty = parseInt($("output", li)?.textContent) || 1;
                total += price * qty;
            });
            el.totalPrice.textContent = total.toFixed(2);
            el.selectedCount.textContent = selected.length;
            el.payBtn.disabled = selected.length === 0;
        };

        const updateItemCount = () => {
            const count = $$("#groceryList li[data-id]").length;
            el.itemCount.textContent = `${count} item${count !== 1 ? "s" : ""}`;
        };

        // Image handling
        const showImage = (src) => {
            imageData = src;
            el.previewImage.src = src;
            el.previewImage.classList.remove("hidden");
            $(".drop-zone-content").classList.add("hidden");
            el.scanBtn.disabled = false;
            el.clearImageBtn.classList.remove("hidden");
            setStatus("Ready to scan", "success");
        };

        const clearImage = () => {
            imageData = null;
            el.previewImage.src = "";
            el.previewImage.classList.add("hidden");
            $(".drop-zone-content").classList.remove("hidden");
            el.scanBtn.disabled = true;
            el.clearImageBtn.classList.add("hidden");
            el.receiptInput.value = "";
            setStatus("");
        };

        const loadFile = (file) => {
            if (!file?.type.startsWith("image/")) {
                setStatus("Please select an image", "error");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => showImage(e.target.result);
            reader.readAsDataURL(file);
        };

        // Scanning
        const scanReceipt = async () => {
            if (!imageData) return;
            el.scanBtn.disabled = true;
            setStatus("Scanning...");
            try {
                const { items = [] } = await api("/groceries/upload", "POST", { image: imageData });
                if (!items.length) {
                    setStatus("No items found", "error");
                    return;
                }
                scannedData = items;
                setStatus(`Found ${items.length} items`, "success");
                renderScanned();
            } catch (e) {
                setStatus(e.message, "error");
            } finally {
                el.scanBtn.disabled = false;
            }
        };

        const renderScanned = () => {
            el.scannedItems.innerHTML = scannedData.map((item, i) => {
                const unitPrice = item.unit_price != null ? item.unit_price : (item.price != null && item.quantity ? (item.price / item.quantity) : null);
                return `
      <li data-index="${i}" class="list-item">
        <div class="flex-1">
            <input type="text" name="name" value="${escapeHtml(item.name)}" class="input-transparent w-100" placeholder="Item name">
        </div>
        <div class="flex-row items-center gap-05">
            <fieldset class="quantity-control">
                <button type="button" data-action="decrement">−</button>
                <output>${item.quantity || 1}</output>
                <button type="button" data-action="increment">+</button>
            </fieldset>
            <div class="input-group">
                <span>$</span>
                <input type="number" name="unit_price" value="${unitPrice != null ? unitPrice.toFixed(2) : "0.00"}" step="0.01" min="0" class="input-transparent" placeholder="0.00">
            </div>
            <button type="button" data-action="remove" class="btn-icon">×</button>
        </div>
      </li>
    `;
            }).join("");
            el.scannedPreview.classList.remove("hidden");
        };

        const clearScanned = () => {
            scannedData = [];
            el.scannedPreview.classList.add("hidden");
            el.scannedItems.innerHTML = "";
        };

        const addAllScanned = async () => {
            const items = $$("#scannedItems li").map(li => {
                const qty = parseInt($("output", li)?.textContent) || 1;
                const unitPrice = parseFloat($("[name=unit_price]", li).value) || null;
                const price = unitPrice != null ? +(unitPrice * qty).toFixed(2) : null;
                return {
                    name: $("[name=name]", li).value.trim(),
                    quantity: qty,
                    price
                };
            }).filter(i => i.name);
            if (!items.length) return;
            try {
                await api("/groceries/bulk-add", "POST", { items });
                location.reload();
            } catch (e) {
                setStatus(e.message, "error");
            }
        };

        // Create item element
        const createItem = ({ id, name, quantity, price }) => {
            const li = document.createElement("li");
            li.dataset.id = id;
            li.className = "list-item";
            li.innerHTML = `
      <label class="checkbox flex-shrink-0"><input type="checkbox" name="selected"></label>
      <div class="flex-1">
          <input type="text" name="name" value="${escapeHtml(name)}" class="input-transparent w-100" placeholder="Item name">
      </div>
      <div class="flex-row items-center gap-05">
          <fieldset class="quantity-control">
            <button type="button" data-action="decrement">−</button>
            <output>${quantity}</output>
            <button type="button" data-action="increment">+</button>
          </fieldset>
          <div class="input-group">
            <span>$</span>
            <input type="number" name="price" value="${price || "0.00"}" step="0.01" min="0" placeholder="0.00">
          </div>
          <button type="button" data-action="delete" class="btn-icon">×</button>
      </div>
    `;
            return li;
        };

        // CRUD operations
        const addItem = async () => {
            const name = el.addItemName.value.trim();
            if (!name) return;
            try {
                const qtyOutput = $("#addItemQty", el.addItemSection);
                const quantity = parseInt(qtyOutput.textContent) || 1;

                const item = await api("/groceries/add", "POST", {
                    name,
                    quantity,
                    price: null
                });
                $(".empty-state", el.groceryList)?.remove();
                el.groceryList.appendChild(createItem(item));
                form.reset();
                qtyOutput.textContent = "1";
                form.name.focus();
                el.addItemName.value = "";
                qtyOutput.textContent = "1";
                el.addItemName.focus();
                updateItemCount();
            } catch (e) {
                alert(e.message);
            }
        };

        const updateItem = async (id, field, value) => {
            try {
                await api(`/groceries/${id}`, "PUT", { [field]: value });
            } catch (e) {
                alert(e.message);
            }
        };

        const deleteItem = async (li) => {
            try {
                await api(`/groceries/${li.dataset.id}`, "DELETE");
                li.remove();
                updateTotals();
                updateItemCount();
                if (!$("[data-id]", el.groceryList)) {
                    el.groceryList.innerHTML = '<li class="empty-state">No items yet</li>';
                }
            } catch (e) {
                alert(e.message);
            }
        };

        const paySelected = async () => {
            const ids = $$("#groceryList li.selected").map(li => li.dataset.id);
            if (!ids.length) return;
            try {
                await api("/groceries/pay", "POST", { item_ids: ids });
                location.reload();
            } catch (e) {
                alert(e.message);
            }
        };

        // Event: Drop zone
        el.dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.dropZone.classList.add("dragover");
        });
        el.dropZone.addEventListener("dragleave", () => el.dropZone.classList.remove("dragover"));
        el.dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            el.dropZone.classList.remove("dragover");
            loadFile(e.dataTransfer.files[0]);
        });
        el.dropZone.addEventListener("click", () => el.receiptInput.click());
        el.receiptInput.addEventListener("change", (e) => loadFile(e.target.files[0]));

        // Event: Scan controls
        el.scanBtn.addEventListener("click", scanReceipt);
        el.clearImageBtn.addEventListener("click", clearImage);
        el.addAllBtn.addEventListener("click", addAllScanned);
        el.clearScanBtn.addEventListener("click", clearScanned);

        // Event: Scanned items
        el.scannedItems.addEventListener("click", (e) => {
            const li = e.target.closest("li");
            if (!li) return;
            const action = e.target.dataset.action;

            if (action === "remove") {
                const i = parseInt(li.dataset.index);
                scannedData.splice(i, 1);
                scannedData.length ? renderScanned() : clearScanned();
            } else if (action === "increment" || action === "decrement") {
                const output = $("output", li);
                let qty = parseInt(output?.textContent) || 1;
                if (action === "increment") output.textContent = ++qty;
                else if (qty > 1) output.textContent = --qty;
            }
        });



        // Event: Add item form
        el.addItemForm.addEventListener("click", (e) => {
            if (e.target.tagName !== "BUTTON") return;
            const action = e.target.dataset.action;
            if (!action) return; // e.g. submit button

            const output = $("#addItemQty", el.addItemForm);
            let qty = parseInt(output.textContent) || 1;

            if (action === "increment") {
                output.textContent = ++qty;
            } else if (action === "decrement" && qty > 1) {
                output.textContent = --qty;
            }
        });

        el.addItemForm.addEventListener("submit", addItem);
        el.addItemSection.addEventListener("click", (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;

            const action = btn.dataset.action;
            if (action) {
                const output = $("#addItemQty", el.addItemSection);
                let qty = parseInt(output.textContent) || 1;
                if (action === "increment") output.textContent = ++qty;
                else if (action === "decrement" && qty > 1) output.textContent = --qty;
            } else if (btn.id === "addItemBtn") {
                addItem();
            }
        });

        el.addItemName.addEventListener("keypress", (e) => {
            if (e.key === "Enter") addItem();
        });

        // Event: Grocery list
        el.groceryList.addEventListener("click", (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;

            const action = e.target.dataset.action;
            const output = $("output", li);
            let qty = parseInt(output?.textContent) || 1;

            if (action === "increment") {
                qty++;
                output.textContent = qty;
                updateItem(li.dataset.id, "quantity", qty);
                updateTotals();
            } else if (action === "decrement" && qty > 1) {
                qty--;
                output.textContent = qty;
                updateItem(li.dataset.id, "quantity", qty);
                updateTotals();
            } else if (action === "delete") {
                deleteItem(li);
            }
        });

        el.groceryList.addEventListener("change", (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;

            const { name, value, checked } = e.target;

            if (name === "selected") {
                li.classList.toggle("selected", checked);
                updateTotals();
            } else if (name === "name") {
                updateItem(li.dataset.id, "name", value.trim());
            } else if (name === "price") {
                updateItem(li.dataset.id, "price", parseFloat(value) || null);
                updateTotals();
            }
        });

        // Event: Pay button
        el.payBtn.addEventListener("click", paySelected);

        // Event: Format money inputs to 2 decimal places on blur
        document.addEventListener("blur", (e) => {
            if (e.target.matches(".input-group input[type='number']")) {
                const val = parseFloat(e.target.value);
                if (!isNaN(val)) e.target.value = val.toFixed(2);
            }
        }, true);

        // Initialize
        updateTotals();
    })();
</script>
{% endblock %}